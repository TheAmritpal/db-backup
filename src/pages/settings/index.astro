---
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect("/auth/sign-in");
}
import AdminLayout from "@/layouts/AdminLayout.astro";
import {
  GOOGLE_CLIENT_ID,
  GOOGLE_CLIENT_SECRET,
  GOOGLE_REDIRECT_URI,
} from "@/server/settings/setting.constant";
import { treaty } from "@elysiajs/eden";
import type { App } from "@/server/elysia";
const app = treaty<App>("localhost:4321");
const { data } = await app.api.setting.index.get();
---

<script>
  import { treaty } from "@elysiajs/eden";
  import type { App } from "@/server/elysia";
  import Swal from "sweetalert2";
  import {
    GOOGLE_CLIENT_ID,
    GOOGLE_CLIENT_SECRET,
    GOOGLE_REDIRECT_URI,
  } from "@/server/settings/setting.constant";
  const app = treaty<App>("localhost:4321");
  const settingsForm = document.querySelector<HTMLElement>("#settingsForm");
  const google_client_id = document.querySelector<HTMLInputElement>(
    `#${GOOGLE_CLIENT_ID}`
  );
  const google_client_secret = document.querySelector<HTMLInputElement>(
    `#${GOOGLE_CLIENT_SECRET}`
  );
  const google_redirect_uri = document.querySelector<HTMLInputElement>(
    `#${GOOGLE_REDIRECT_URI}`
  );
  const submitBtn = document.querySelector<HTMLElement>(".submitBtn");
  if (settingsForm) {
    settingsForm.addEventListener("submit", async (event: Event) => {
      event.preventDefault();
      try {
        if (!google_client_id || !google_client_secret || !google_redirect_uri) {
          return Swal.fire({
            title: "Invalid form",
            text: "Please enter valid credentials",
            icon: "error",
          });
        }
        const postData = [
          {
            name: GOOGLE_CLIENT_ID,
            value: google_client_id.value,
            description: "Google Client ID",
          },
          {
            name: GOOGLE_CLIENT_SECRET,
            value: google_client_secret.value,
            description: "Google Client Secret",
          },
          {
            name: GOOGLE_REDIRECT_URI,
            value: google_redirect_uri.value,
            description: "Google Redirect Uri",
          },
        ];
        const { data, error } = await app.api.setting.index.post(postData);
        if (error) throw error;
        if (data.success) {
          Swal.fire({
            title: "Success",
            text: data.message[0],
            icon: "success",
          });
        } else {
          Swal.fire({
            title: "error",
            text: data.message[0],
            icon: "error",
          });
        }
      } catch (error) {
        const customError = error as {
          status: number;
          value:
            | {
                success: boolean;
                message: string[];
              }
            | string;
        };
        const errorMessage =
          typeof customError.value === "string"
            ? customError.value
            : customError.value.message[0];
        Swal.fire({
          position: "center",
          icon: "error",
          title: errorMessage,
          showConfirmButton: false,
          timer: 2000,
          showCloseButton: true,
        });
      }
    });
  }
</script>
<AdminLayout>
  <div class="container-fluid">
    <!-- start page title -->
    <div class="row">
      <div class="col-12">
        <div
          class="page-title-box d-sm-flex align-items-center justify-content-between bg-galaxy-transparent"
        >
          <h4 class="mb-sm-0">Settings</h4>

          <div class="page-title-right">
            <ol class="breadcrumb m-0">
              <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
              <li class="breadcrumb-item active">Settings</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
    <!-- end page title -->

    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-header align-items-center d-flex">
            <h4 class="card-title mb-0 flex-grow-1">Google Drive Settings</h4>
          </div><!-- end card header -->

          <div class="card-body">
            <div class="live-preview">
              <form
                class="row g-3 needs-validation"
                id="settingsForm"
                novalidate
                autocomplete="off"
              >
                <div class="col-md-4">
                  <label for={GOOGLE_CLIENT_ID} class="form-label">Google Client ID</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id={GOOGLE_CLIENT_ID}
                    name={GOOGLE_CLIENT_ID}
                    autocomplete="off"
                    value={data?.filter(
                      (element) => element.name === GOOGLE_CLIENT_ID
                    )?.[0]?.value || ""}
                    required
                  />
                  <div class="valid-feedback">Looks good!</div>
                </div>
                <div class="col-md-4">
                  <label for={GOOGLE_CLIENT_SECRET} class="form-label"
                    >Google Client Secret</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id={GOOGLE_CLIENT_SECRET}
                    name={GOOGLE_CLIENT_SECRET}
                    autocomplete="off"
                    value={data?.filter(
                      (element) => element.name === GOOGLE_CLIENT_SECRET
                    )?.[0]?.value || ""}
                    required
                  />
                  <div class="valid-feedback">Looks good!</div>
                </div>
                <div class="col-md-4">
                  <label for={GOOGLE_REDIRECT_URI} class="form-label">Redirect URI</label>
                  <input
                    type="text"
                    class="form-control"
                    id={GOOGLE_REDIRECT_URI}
                    name={GOOGLE_REDIRECT_URI}
                    autocomplete="off"
                    value={data?.filter(
                      (element) => element.name === GOOGLE_REDIRECT_URI
                    )?.[0]?.value || ""}
                    required
                  />
                  <div class="valid-feedback">Looks good!</div>
                </div>
                <div class="col-12">
                  <button class="btn btn-primary submitBtn" type="submit">Update</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- end col -->
    </div>
  </div>
  <!-- container-fluid -->
</AdminLayout>
